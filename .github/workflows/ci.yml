# CI/CD Pipeline for SynthCode VSCode Extension
# Enforcing Zero-Defect, High-Velocity Standards (2025/2026)

name: SynthCode CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# Global permissions required for publishing or advanced interactions
permissions:
  contents: write
  pull-requests: write

jobs:
  matrix_build:
    name: Build & Test (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: ['20.x', '22.x']

    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4

      - name: 2. Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: 3. Install Dependencies (uv equivalent for JS/TS)
        run: npm ci

      - name: 4. Run Static Analysis (Biome/Ruff Equivalent)
        # We use Biome here as per Scenario A stack definition for TS projects
        run: npx @biomejs/biome check --apply=false --error-on-warnings

      - name: 5. Run Unit Tests (Vitest)
        # Assuming Vitest is configured for coverage reporting
        run: npx vitest run --coverage

      - name: 6. Archive Code Coverage Report (Codecov)
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage/cobertura-coverage.xml
        if: success() && matrix.node-version == '22.x'

      - name: 7. Build Extension Package
        run: npm run build

      - name: 8. Verification: Run End-to-End Tests (Playwright)
        # This step validates the built extension in a real browser context
        # Requires installing browsers for Playwright
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
        run: npx playwright install --with-deps
        # Assuming 'npm run test:e2e' executes Playwright tests
        # Note: For VSCode extensions, E2E testing often requires specific setup like `vscode-test` or the Playwright VSCode Test Runner Extension context.
        # We use a placeholder command adhering to the specified stack.
        run: npm run test:e2e

  security_scan:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4

      - name: 2. Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'

      - name: 3. Install Dependencies
        run: npm ci

      - name: 4. Dependency Vulnerability Check (Snyk/npm audit)
        # Using npm audit for baseline compliance before external tools
        run: npm audit --production
        env:
          # Replace with actual secrets if using Snyk or similar services
          # SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

  deploy:
    name: Deploy to Marketplace (Conditional)
    needs: [matrix_build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: Production

    steps:
      - name: 1. Checkout Repository
        uses: actions/checkout@v4

      - name: 2. Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: 3. Install Dependencies
        run: npm ci

      - name: 4. Create Marketplace Artifact (VSIX)
        run: npm run package

      - name: 5. Publish to VS Code Marketplace
        # Requires VSCE tool and access tokens configured as secrets
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'
        run: npm install -g vsce
        run: vsce publish -p ${{ secrets.VSCE_PAT }}
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
